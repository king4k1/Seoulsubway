---
title: "Untitled"
author: "Kwangmin Son"
date: "2019년 6월 2일"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(seoulsubway)
library(sp)
API_key <- 'AIzaSyCvFJzO8nrvmospv--Mhi9XypO7PvBcZcw'
register_google(key = API_key)
data(subway_data_DT)


address_station <- function(code, apikey) {
  base_url <- "http://openAPI.seoul.go.kr:8088/"
  url_fed_to_get <- paste0(base_url,apikey, "/xml",
                           '/SearchSTNInfoByFRCodeService',
                           '/1/5/', code)
  APItree <- xmlTreeParse(url_fed_to_get, useInternalNodes = TRUE)
  APIroot <- xmlRoot(APItree)
  APIports <- APIroot[[3]]
  result <- data.frame("STATION_NM" =  
                         xmlApply(APIports[2]$STATION_NM, xmlValue)$text,
                       "STATION_NM_ENG" = 
                         xmlApply(APIports[3]$STATION_NM_ENG, xmlValue)$text,
                       "address" = 
                         xmlApply(APIports[13]$ADDRESS, xmlValue)$text,
                       "lat" =
                         xmlApply(APIports[36]$XPOINT_WGS, xmlValue)$text,
                       "long" = xmlApply(APIports[37]$YPOINT_WGS, xmlValue)$text)
  return(result)
}

```

```{r}
raw_shp <- rgdal::readOGR("shape_data/TL_SPSB_RLWAY.shp")
stn_shp <- rgdal::readOGR("shape_data/TL_SPSB_STATN.shp")
line_subway <- c('1호선', '2호선', '3호선', '4호선', '5호선', '6호선',
                 '7호선', '8호선', '9호선', '경의중앙선', '우이신설선',
                 '분당선', '신분당선', '공항선')

### 자료 전처리 / long-lat 구조 / 역명
seoul_subwayline <- raw_shp[raw_shp@data$KOR_SBR_NM%in%line_subway,]
seoul_subwayline <- spTransform(seoul_subwayline, "+proj=longlat")
seoul_subwayline <- seoul_subwayline[str_detect(seoul_subwayline@data$SIG_CD, "^1|^4|^28"),]
dep_name <- stn_shp@data$KOR_SUB_NM
dep_name_index <- which(str_detect(dep_name, "[(]"))
dep_name_index_nm <- str_locate(dep_name[dep_name_index], "[(]")
dep_name <- as.character(dep_name)
dep_name[dep_name_index] <- str_sub(dep_name[dep_name_index], 1, dep_name_index_nm[, 1] - 1)
length_index <- str_length(dep_name[str_detect(dep_name, "역$")])
dep_name[str_detect(dep_name, "역$")] <- str_sub(dep_name[str_detect(dep_name, "역$")], 1, length_index-1)
stn_shp@data$KOR_SUB_NM <- dep_name
stn_shp <- spTransform(stn_shp, "+proj=longlat")
stn_shp_edit <- stn_shp[stn_shp@data$KOR_SUB_NM %in% subway_data_DT$Name,]
stn_shp_edit <- stn_shp_edit[str_detect(stn_shp_edit@data$SIG_CD, "^1|^4|^28"),]
```


## get_section
```{r}
seoul_subwayline_fty <- seoul_subwayline %>% fortify(region="KOR_SBR_NM")
stn_shp_fty <- stn_shp_edit %>% fortify(region='KOR_SUB_NM')
stn_shp_fty$group_id <- stn_shp_fty$group
stn_shp_fty_trim_mean <- stn_shp_fty %>% group_by(group_id) %>%
  summarise(long = mean(long, trim=0.2), lat=mean(lat, trim=0.2)) 

line_choose <- "경의중앙선"
get_section <- function(line_choose){
  line_1_fty <- seoul_subwayline[seoul_subwayline@data$KOR_SBR_NM%in%line_choose,] %>% fortify()
  if(line_choose %>% str_detect("[1-9]")){
    line_select <- str_remove(line_choose, "호선")
  }else if(line_choose == "경의중앙선"){line_select <- "K"
  }else if(line_choose == "우이신설선"){line_select <- "UI"
  }else if(line_choose == "분당선"){line_select <- "B"
  }else if(line_choose == "신분당선"){line_select <- "S"
  }else if(line_choose == "공항선"){line_select <- "A"}
  line_1_nms <- subway_data_DT %>% filter(Line %in% line_select)
  line_1_fty <- line_1_fty %>% filter(!duplicated(long, lat))
  stn_shp_fty_line1 <- stn_shp_fty_trim_mean %>% filter(long <= 127.5) %>% 
    mutate(group_id = str_remove(group_id, ".[1-9]")) %>% 
    filter(group_id %in% line_1_nms$Name) %>% filter(!duplicated(group_id))
  ind <- setdiff(line_1_nms$Name, stn_shp_fty_line1$group_id)
  stn_shp_fty_line1 <- stn_shp_fty_line1 %>% 
    rbind(line_1_nms %>% 
            filter(Name %in% ind) %>%
            select(Name, long, lat) %>% 
    mutate(Name = factor(Name)) %>% rename(group_id=Name))
  setdiff(line_1_nms$Name, stn_shp_fty_line1$group_id)
  unique(stn_shp_fty_line1$group_id) %>% str_sort
  line_1_nms$Name %>% str_sort
  stn_shp_fty_line1 <- stn_shp_fty_line1 %>% 
    mutate(group_id = factor(group_id, levels=line_1_nms$Name),
           station_lev = as.numeric(group_id)) %>% arrange(station_lev)
  section_select <- c()
  for(i in 1:(nrow(stn_shp_fty_line1)-1)){
    long_select <- stn_shp_fty_line1[c(i, i+1),]$long # stn_shp_fty_line1[c(i, i+1),] 
    lat_select <- stn_shp_fty_line1[c(i, i+1),]$lat
    section <- line_1_fty %>% select(long, lat, id) %>% rename(group_id=id) %>% 
      filter(long >= min(long_select), long <= max(long_select)) %>% 
      filter(lat >= min(lat_select), lat <= max(lat_select))
    #section %>% ggplot(aes(x=long, y=lat)) + geom_point()
    group_index <- unique(section$group_id)
    if(length(group_index) == 0){
        section_select[i] <- 
          geosphere::distGeo(p1 = stn_shp_fty_line1[c(i),c("long", "lat")] %>% as.numeric(),
                             p2 = stn_shp_fty_line1[c(i+1),c("long", "lat")] %>% as.numeric())
        ### 두 역이 직선거리여서 선이 정의되지 않는 경우
    }
    if(length(group_index) == 1){
      if(nrow(section) > 1){
        sum_section <- sum(sapply(1:(nrow(section)-1),function(x){
          geosphere::distGeo(p1=c(section$long[x], section$lat[x]),  
                             p2=c(section$long[x+1], section$lat[x+1]))}))
        section_select[i] <- sum_section +
          min(geosphere::distGeo(p1 = c(section[1,"long"], section[1,"lat"]),
                                 p2 = stn_shp_fty_line1[c(i),c("long", "lat")] %>% as.numeric()),
              geosphere::distGeo(p1 = c(section[nrow(section),"long"], section[nrow(section),"lat"]),
                                 p2 = stn_shp_fty_line1[c(i),c("long", "lat")] %>% as.numeric())) +
          min(geosphere::distGeo(p1 = c(section[1,"long"], section[1,"lat"]),
                                 p2 = stn_shp_fty_line1[c(i+1),c("long", "lat")] %>% as.numeric()),
              geosphere::distGeo(p1 = c(section[nrow(section),"long"], section[nrow(section),"lat"]),
                                 p2 = stn_shp_fty_line1[c(i+1),c("long", "lat")] %>% as.numeric())) 
      }else{
        section_select[i] <- min(geosphere::distGeo(p1 = c(section[1,"long"], section[1,"lat"]),
                                 p2 = stn_shp_fty_line1[c(i),c("long", "lat")] %>% as.numeric()),
              geosphere::distGeo(p1 = c(section[nrow(section),"long"], section[nrow(section),"lat"]),
                                 p2 = stn_shp_fty_line1[c(i),c("long", "lat")] %>% as.numeric())) +
          min(geosphere::distGeo(p1 = c(section[1,"long"], section[1,"lat"]),
                                 p2 = stn_shp_fty_line1[c(i+1),c("long", "lat")] %>% as.numeric()),
              geosphere::distGeo(p1 = c(section[nrow(section),"long"], section[nrow(section),"lat"]),
                                 p2 = stn_shp_fty_line1[c(i+1),c("long", "lat")] %>% as.numeric())) 
      }
    }
    if(length(group_index) == 2){
      section_list_i <- list()
      for(j in seq_along(group_index)){
        section_i <- section %>% filter(group_id == group_index[j])
        ## 2개 shp line으로 두 역 사이가 선택되는 경우 
        if(nrow(section_i) > 1){
          if(sum(sapply(1:(nrow(section_i)-1), function(x){
            geosphere::distGeo(p1=c(section_i$long[x], section_i$lat[x]),
                               p2=c(section_i$long[x+1], section_i$lat[x+1]))
          }) >= 500)>=1){
            section_i <- section_i %>% arrange(long, lat)
            sum_section <- sum(sapply(1:(nrow(section_i)-1), function(x){
            geosphere::distGeo(p1=c(section_i$long[x], section_i$lat[x]),
                               p2=c(section_i$long[x+1], section_i$lat[x+1]))}))
          }else{
          sum_section <- sum(sapply(1:(nrow(section_i)-1), function(x){
            geosphere::distGeo(p1=c(section_i$long[x], section_i$lat[x]),
                               p2=c(section_i$long[x+1], section_i$lat[x+1]))
          }))
          }
          section_list_i[[j]] <- sum_section +
          min(
          geosphere::distGeo(p1 = c(section_i[1,"long"], section_i[1,"lat"]),
                             p2 = stn_shp_fty_line1[c(i+1),c("long", "lat")] %>% as.numeric()),
          geosphere::distGeo(p1 = c(section_i[nrow(section_i),"long"], section_i[nrow(section_i),"lat"]),
                             p2 = stn_shp_fty_line1[c(i+1),c("long", "lat")] %>% as.numeric()),
          geosphere::distGeo(p1 = c(section_i[1,"long"], section_i[1,"lat"]),
                             p2 = stn_shp_fty_line1[c(i),c("long", "lat")] %>% as.numeric()),
          geosphere::distGeo(p1 = c(section_i[nrow(section_i),"long"], section_i[nrow(section_i),"lat"]),
                             p2 = stn_shp_fty_line1[c(i),c("long", "lat")] %>% as.numeric())) 
        }else{
          #stn_shp_fty_line1[c(i, i+1),]
        section_list_i[j] <- min(
          geosphere::distGeo(p1 = c(section[1,"long"], section[1,"lat"]),
                             p2 = stn_shp_fty_line1[c(i-j+1),c("long", "lat")] %>% as.numeric()),
          geosphere::distGeo(p1 = c(section[nrow(section),"long"], section[nrow(section),"lat"]),
                             p2 = stn_shp_fty_line1[c(i-j+1),c("long", "lat")] %>% as.numeric())) 
      }
      }
      section_select[i] <- section_list_i %>% unlist() %>% sum()
    }
    if(length(group_index) > 2){
      section <- section %>% arrange(long, lat)
      sum_section <- sum(sapply(1:(nrow(section)-1), function(x){
        geosphere::distGeo(p1=c(section$long[x], section$lat[x]),
                           p2=c(section$long[x+1], section$lat[x+1]))
      }))
      section_select[i] <- sum_section +
        min(geosphere::distGeo(p1 = c(section[1,"long"], section[1,"lat"]),
                               p2 = stn_shp_fty_line1[c(i),c("long", "lat")] %>% as.numeric()),
            geosphere::distGeo(p1 = c(section[nrow(section),"long"], section[nrow(section),"lat"]),
                               p2 = stn_shp_fty_line1[c(i),c("long", "lat")] %>% as.numeric()),
            geosphere::distGeo(p1 = c(section[1,"long"], section[1,"lat"]),
                               p2 = stn_shp_fty_line1[c(i+1),c("long", "lat")] %>% as.numeric()),
            geosphere::distGeo(p1 = c(section[nrow(section),"long"], section[nrow(section),"lat"]),
                               p2 = stn_shp_fty_line1[c(i+1),c("long", "lat")] %>% as.numeric())) 
    }# stn_shp_fty_line1[c(i, i+1),]$long
    section_select[i] <-
      max(geosphere::distGeo(p1=c(stn_shp_fty_line1[c(i, i+1),]$long[1], stn_shp_fty_line1[c(i, i+1),]$lat[1]),
                             p2=c(stn_shp_fty_line1[c(i, i+1),]$long[2], stn_shp_fty_line1[c(i, i+1),]$lat[2])),
          section_select[i])
  }
  stn_shp_fty_line1 %>% select(group_id, long, lat) %>% mutate(dist = c(0, section_select)) %>% rename(Name = group_id)
}

get_section(line_choose = "1호선") %>% knitr::kable()
get_section(line_choose = "2호선") %>% knitr::kable()
get_section(line_choose = "3호선") %>% knitr::kable()
get_section(line_choose = "4호선") %>% knitr::kable()
get_section(line_choose = "7호선") %>% knitr::kable()
get_section(line_choose = "8호선") %>% knitr::kable()
get_section(line_choose = "9호선") %>% knitr::kable()


```


