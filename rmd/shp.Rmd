---
title: "Untitled"
author: "Kwangmin Son"
date: "2019년 6월 2일"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(seoulsubway)
library(sp)
data(subway_data_DT)
```

```{r}
raw_shp <- rgdal::readOGR("shape_data/TL_SPSB_RLWAY.shp")
stn_shp <- rgdal::readOGR("shape_data/TL_SPSB_STATN.shp")
line_subway <- c('1호선', '2호선', '3호선', '4호선', '5호선', '6호선',
                 '7호선', '8호선', '9호선', '경의중앙선', '우이신설선',
                 '분당선', '신분당선', '공항선')

### 자료 전처리 / long-lat 구조 / 역명
seoul_subwayline <- raw_shp[raw_shp@data$KOR_SBR_NM%in%line_subway,]
seoul_subwayline <- spTransform(seoul_subwayline, "+proj=longlat")
seoul_subwayline <- seoul_subwayline[str_detect(seoul_subwayline@data$SIG_CD, "^1|^4|^28"),]
dep_name <- stn_shp@data$KOR_SUB_NM
dep_name_index <- which(str_detect(dep_name, "[(]"))
dep_name_index_nm <- str_locate(dep_name[dep_name_index], "[(]")
dep_name <- as.character(dep_name)
dep_name[dep_name_index] <- str_sub(dep_name[dep_name_index], 1, dep_name_index_nm[, 1] - 1)
length_index <- str_length(dep_name[str_detect(dep_name, "역$")])
dep_name[str_detect(dep_name, "역$")] <- str_sub(dep_name[str_detect(dep_name, "역$")], 1, length_index-1)
stn_shp@data$KOR_SUB_NM <- dep_name
stn_shp <- spTransform(stn_shp, "+proj=longlat")
stn_shp_edit <- stn_shp[stn_shp@data$KOR_SUB_NM %in% subway_data_DT$Name,]
stn_shp_edit <- stn_shp_edit[str_detect(stn_shp_edit@data$SIG_CD, "^1|^4|^28"),]
```


## get_section
```{r}
seoul_subwayline_fty <- seoul_subwayline %>% fortify(region="KOR_SBR_NM")

line_choose <- 1
stn_shp_fty <- stn_shp %>% fortify(region='KOR_SUB_NM')
stn_shp_fty$group_id <- stn_shp_fty$group
stn_shp_fty_median <- stn_shp_fty %>% group_by(group_id) %>%
  summarise(long = median(long), lat=median(lat)) 

ss <- 
ggplot(ss, aes(x=long, y=lat)) + geom_point()


ggplot(stn_shp_fty_mean %>% 
         filter(Name %in% line_1_nms$Name) %>% 
         mutate(cols = 1:86),
       aes(x=long, y=lat, col=cols)) + geom_point()

ggplot(stn_shp_fty_mean, aes(x=long, y=lat, col=Name)) + geom_point()

get_section <- function(line_choose){
  line_1_fty <- seoul_subwayline[seoul_subwayline@data$KOR_SBR_NM%in%c(paste0(line_choose, "호선")),] %>% fortify()
  line_1_nms <- subway_data_DT %>% filter(Line %in% c(line_choose))
  stn_shp_fty_line1 <- stn_shp_fty_median %>% filter(long <= 127.5) %>% 
    mutate(group_id = str_remove(group_id, ".[1-9]")) %>% 
    filter(group_id %in% line_1_nms$Name) %>% filter(!duplicated(group_id))
  ind <- setdiff(line_1_nms$Name, stn_shp_fty_line1$group_id)
  stn_shp_fty_line1 <- stn_shp_fty_line1 %>% 
    rbind(line_1_nms %>% 
            filter(Name %in% ind) %>%
            select(Name, long, lat) %>% 
    mutate(Name = factor(Name)) %>% rename(group_id=Name))
  stn_shp_fty_line1 <- stn_shp_fty_line1 %>% 
    mutate(group_id = factor(group_id, levels=line_1_nms$Name),
           station_lev = as.numeric(group_id)) %>% arrange(station_lev)
  section_select <- c()
  for(i in 1:(nrow(stn_shp_fty_line1)-1)){
    long_select <- stn_shp_fty_line1[c(i, i+1),]$long # stn_shp_fty_line1[c(i, i+1),]
    lat_select <- stn_shp_fty_line1[c(i, i+1),]$lat
    section <- line_1_fty %>% select(long, lat, id) %>% rename(group_id=id) %>% 
      rbind(stn_shp_fty_line1[c(i, i+1),1:3]) %>% arrange(long, lat) %>% 
      filter(long >= min(long_select), long <= max(long_select)) %>% 
      filter(lat >= min(lat_select), lat <= max(lat_select))
    section_select[i] <- 
      sum(sapply(1:(nrow(section)-1), function(x){
        geosphere::distGeo(p1=c(section$long[x], section$lat[x]),
                           p2=c(section$long[x+1], section$lat[x+1]))
      }))
   
  }
  section_select
}
```


```{r}
### 1호선을 예시로 선택하는 과정


### 하나의 지하철에 대하여  여러개의 출구값을 산출하므로 평균을 통해 역 중심위치 계산
ggmap(get_map(c(126.8446, 37.48050), zoom = 11)) +
  geom_point(data=stn_1_fty_mean %>% filter(id %in% 11), aes(x=long, y=lat))


```

