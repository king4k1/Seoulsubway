---
title: "MVA with Subwaydata for Cluster Analysis"
author: |
  | KwangMin Son
  | Department of Statistics, SKKU
date: "\today"
output:
  html_document:
    df_print: paged
header-includes: \usepackage{kotex}
incremental: yes
fontsize: 9pt
editor_options:
  chunk_output_type: console
---

### 필요 패키지 및 데이터
```{r, message=FALSE}
library(data.table)
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(MVA)

load(file="transaction.RData")
```

```{r, include=FALSE, eval=FASLE}
load(file='C:/Users/82104/Desktop/subwaydat/dat_etc_down.RData')
load(file='C:/Users/82104/Desktop/subwaydat/dat_etc_up.RData')
load(file='C:/Users/82104/Desktop/subwaydat/dat_ordina_down.RData')
load(file='C:/Users/82104/Desktop/subwaydat/dat_ordina_up.RData')
load(file='C:/Users/82104/Desktop/subwaydat/dat_gyeongro_down.RData')
load(file='C:/Users/82104/Desktop/subwaydat/dat_gyeongro_up.RData')
names(dat_etc_down) <- iconv(names(dat_etc_down), from="UTF-8", to="euc-KR")
names(dat_etc_up) <- iconv(names(dat_etc_up), from="UTF-8", to="euc-KR")
names(dat_gyeongro_up) <- iconv(names(dat_gyeongro_up), from="UTF-8", to="euc-KR")
names(dat_gyeongro_down) <- iconv(names(dat_gyeongro_down), from="UTF-8", to="euc-KR")
names(dat_ordinal_up) <- iconv(names(dat_ordinal_up), from="UTF-8", to="euc-KR")
names(dat_ordinal_down) <- iconv(names(dat_ordinal_down), from="UTF-8", to="euc-KR")
dat_etc_down$하차역명 <- iconv(dat_etc_down$하차역명, from="UTF-8", to="euc-KR")
dat_gyeongro_down$하차역명 <- iconv(dat_gyeongro_down$하차역명, from="UTF-8", to="euc-KR")
dat_ordinal_down$하차역명 <- iconv(dat_ordinal_down$하차역명, from="UTF-8", to="euc-KR")

dat_etc_up$승차역명 <- iconv(dat_etc_up$승차역명, from="UTF-8", to="euc-KR")
dat_gyeongro_up$승차역명 <- iconv(dat_gyeongro_up$승차역명, from="UTF-8", to="euc-KR")
dat_ordinal_up$승차역명 <- iconv(dat_ordinal_up$승차역명, from="UTF-8", to="euc-KR")

dat_etc_down$하차역명 <- iconv(dat_etc_down$하차역명, from="UTF-8", to="euc-KR")
dat_gyeongro_down$하차역명 <- iconv(dat_gyeongro_down$하차역명, from="UTF-8", to="euc-KR")
dat_ordinal_down$하차역명 <- iconv(dat_ordinal_down$하차역명, from="UTF-8", to="euc-KR")

dat_etc_up$요일 <- iconv(dat_etc_up$요일, from="UTF-8", to="euc-KR")
dat_gyeongro_up$요일 <- iconv(dat_gyeongro_up$요일, from="UTF-8", to="euc-KR")
dat_ordinal_up$요일 <- iconv(dat_ordinal_up$요일, from="UTF-8", to="euc-KR")

dat_etc_down$요일 <- iconv(dat_etc_down$요일, from="UTF-8", to="euc-KR")
dat_gyeongro_down$요일 <- iconv(dat_gyeongro_down$요일, from="UTF-8", to="euc-KR")
dat_ordinal_down$요일 <- iconv(dat_ordinal_down$요일, from="UTF-8", to="euc-KR")

save(file="C:/Users/82104/Desktop/subwayTransaction.RData", dat_etc_down, dat_etc_up, 
    dat_gyeongro_down, dat_gyeongro_up, dat_ordinal_down, dat_ordinal_up)


data1 <- fread(file="/home/students/subway/OD_1_8_1804_1.csv")
data2 <- fread(file="/home/students/subway/OD_1_8_1804_2.csv")
data <- rbind(data1, data2)

# 데이터셋 제작과정 예시
data_weekend_up <- data%>%filter(요일%in%c("토","일"))%>%group_by(시간대, 승차역명, 요일)%>%summarise(sum = sum(Count))

dat_etc_up <- data%>%filter(요일%in%c("월","화","수","목","금"))%>%group_by(시간대, 승차역명, 요일)%>%summarise(sum = sum(Count))

colnames(dat_etc_down) <- c("Day","Time","Name", "Count")
head(dat_etc_down)
dat_etc_down$Name <- str_replace(dat_etc_down$Name, "서울역", "서울")
ind1 <- which(str_detect(dat_etc_down$Name, "[(]"))
ind2 <- str_locate(dat_etc_down$Name[ind1], "[(]")
dat_etc_down$Name[ind1] <- str_sub(dat_etc_down$Name[ind1],1,ind2-1)

colnames(dat_etc_up) <- c("Day","Time","Name", "Count")
head(dat_etc_up)
dat_etc_up$Name <- str_replace(dat_etc_up$Name, "서울역", "서울")
ind1 <- which(str_detect(dat_etc_up$Name, "[(]"))
ind2 <- str_locate(dat_etc_up$Name[ind1], "[(]")
dat_etc_up$Name[ind1] <- str_sub(dat_etc_up$Name[ind1],1,ind2-1)

colnames(dat_gyeongro_up) <- c("Day","Time","Name", "Count")
head(dat_gyeongro_up)
dat_gyeongro_up$Name <- str_replace(dat_gyeongro_up$Name, "서울역", "서울")
ind1 <- which(str_detect(dat_gyeongro_up$Name, "[(]"))
ind2 <- str_locate(dat_gyeongro_up$Name[ind1], "[(]")
dat_gyeongro_up$Name[ind1] <- str_sub(dat_gyeongro_up$Name[ind1],1,ind2-1)

colnames(dat_gyeongro_down) <- c("Day","Time","Name", "Count")
head(dat_gyeongro_down)
dat_gyeongro_down$Name <- str_replace(dat_gyeongro_down$Name, "서울역", "서울")
ind1 <- which(str_detect(dat_gyeongro_down$Name, "[(]"))
ind2 <- str_locate(dat_gyeongro_down$Name[ind1], "[(]")
dat_gyeongro_down$Name[ind1] <- str_sub(dat_gyeongro_down$Name[ind1],1,ind2-1)

colnames(dat_ordinal_up) <- c("Day","Time","Name", "Count")
head(dat_ordinal_up)
dat_ordinal_up$Name <- str_replace(dat_ordinal_up$Name, "서울역", "서울")
ind1 <- which(str_detect(dat_ordinal_up$Name, "[(]"))
ind2 <- str_locate(dat_ordinal_up$Name[ind1], "[(]")
dat_ordinal_up$Name[ind1] <- str_sub(dat_ordinal_up$Name[ind1],1,ind2-1)

colnames(dat_ordinal_down) <- c("Day","Time","Name", "Count")
head(dat_ordinal_down)
dat_ordinal_down$Name <- str_replace(dat_ordinal_down$Name, "서울역", "서울")
ind1 <- which(str_detect(dat_ordinal_down$Name, "[(]"))
ind2 <- str_locate(dat_ordinal_down$Name[ind1], "[(]")
dat_ordinal_down$Name[ind1] <- str_sub(dat_ordinal_down$Name[ind1],1,ind2-1)

attr(dat_ordinal_up,"vars") <- c("Day", "Time")
 
save(file="C:/Users/82104/Desktop/subwaydat/transaction.RData", dat_etc_down, dat_etc_up, dat_gyeongro_down, dat_gyeongro_up, dat_ordinal_up, dat_ordinal_down)

```


### 사용자구분 변수가 일반인 경우 하차역에 대하여 살펴보고자 함.

* 데이터명 : dat_ordinal_down

```{r}
ordinal_weekday_mean_down <- dat_ordinal_down%>%filter(Day%in%c("월", "화", "수", "목", "금"))%>%group_by(Name, Time)%>%summarise(Mean=mean(Count))

ordinal_weekend_mean_down <- dat_ordinal_down%>%filter(Day%in%c("토", "일"))%>%group_by(Name, Time)%>%summarise(Mean=mean(Count))

ordinal_weekday_mean_up <- dat_ordinal_up%>%filter(Day%in%c("월", "화", "수", "목", "금"))%>%group_by(Name, Time)%>%summarise(Mean=mean(Count))

ordinal_weekend_mean_up <- dat_ordinal_up%>%filter(Day%in%c("토", "일"))%>%group_by(Name, Time)%>%summarise(Mean=mean(Count))

### 평일데이터에 대하여 1달 하차 자료의 시간별 평균 분포 확인
ggplot(data= ordinal_weekday_mean_down, aes(x=Time, y=Mean, color=Name)) + geom_line(position = 'jitter') +  theme(legend.position="none")

### 주말데이터에 대하여 1달 하차 자료의 시간별 평균 분포 확인
ggplot(data= ordinal_weekend_mean_down, aes(x=Time, y=Mean, color=Name)) + geom_line(position = 'jitter') + theme(legend.position="none")


```

### Making Group through MDS technique(down)
```{r, warning=FALSE}
dat_weekend_mat_down <- dat_weekend_mean_down%>%spread(Time, Mean)
dat_weekday_mat_down <- dat_weekday_mean_down%>%spread(Time, Mean)
dim(dat_weekday_mat_down)
# NA 값 => 0으로 처리하였음.
for(i in 1:241){
  dat_weekend_mat_down[i,which(is.na(dat_weekend_mat_down[i,]))] <- 0
  dat_weekday_mat_down[i,which(is.na(dat_weekday_mat_down[i,]))] <- 0
}
colnames(dat_weekend_mat_down) <- c("Name", paste0("time", c(0:2, 4:23)))
colnames(dat_weekday_mat_down) <- c("Name", paste0("time", c(0:2, 4:23)))

dist_weekend_down <- dist(dat_weekend_mat_down[,-1])
dist_weekday_down <- dist(dat_weekday_mat_down[,-1])

#평일 자료에 대한 MDS
mds_weekday_down <- cmdscale(dist_weekday_down, k = 10, eig = TRUE)
mds_weekday_down_eig <- mds_weekday_down$eig
head(cumsum(abs(mds_weekday_down_eig)) / sum(abs(mds_weekday_down_eig)))
head(cumsum((mds_weekday_down_eig)^2) / sum((mds_weekday_down_eig)^2))
#처음 1개의 차원으로 충분 확인 후 1/2차원 표현
plot(mds_weekday_down$points[,1], type = "n", main = "Weekday MDS(Down)")
text(mds_weekday_down$points[,1], labels(sort(unique(dat_weekday_down$Name))))

plot(mds_weekday_down$points[,1] * (-1), mds_weekday_down$points[,2] * (-1),
     type = "n", xlab = "Coordinate 1", ylab = "Coordinate 2", main = "Weekday MDS(Down)")
text(mds_weekday_down$points[,1] *(-1), mds_weekday_down$points[,2] * (-1), 
     labels(sort(unique(dat_weekday_down$Name))), cex = 0.7)
### 평일의 경우 근무지가 집중된 회사밀집지역에 대하여 데이터가 구분되는 것을 확인.

#주말 자료에 대한 MDS
mds_weekend_down <- cmdscale(dist_weekend_down, k = 10, eig = TRUE)
mds_weekend_down_eig <- mds_weekend_down$eig
head(cumsum(abs(mds_weekend_down_eig)) / sum(abs(mds_weekend_down_eig)))
head(cumsum((mds_weekend_down_eig)^2) / sum((mds_weekend_down_eig)^2))
#처음 2개의 차원으로 충분 확인 후 1/2차원 표현
plot(mds_weekend_down$points[,1], type = "n", main = "Weekend MDS(Down)")
text(mds_weekend_down$points[,1], labels(sort(unique(dat_weekday_down$Name))))

plot(mds_weekend_down$points[,1] * (-1), mds_weekend_down$points[,2] * (-1),
     type = "n", xlab = "Coordinate 1", ylab = "Coordinate 2", main = "Weekend MDS(Down)")
text(mds_weekend_down$points[,1] *(-1), mds_weekend_down$points[,2] * (-1), 
     labels(sort(unique(dat_weekday_down$Name))), cex = 0.7)
### 주말의 경우 유흥지가 집중된 번화가에 대하여 데이터가 구분되는 것을 확인.
```

### Making Group through PCA technique(down)
```{r, warning=FALSE}
pca_weekday_down <- prcomp(dat_weekday_mat_down[,-1], scale = TRUE)
plot(pca_weekday_down$sdev^2, xlab = "Component number",
     ylab = "Component variance", type = "l", main = "Scree diagram")
cumsum(pca_weekday_down$sdev^2)/sum(pca_weekday_down$sdev^2)
### weekday의 경우 PC 2개로 총 변동에 84.24%를 설명하므로 충분해보임
pca_weekday_down$rotation[,1:2]
### PC1 : 전반적인 하차객수, PC2 : 오전시간 대비 오후시간대의 하차객수(특히 출근시간대 6,7,8,9 높은 값을 가짐)
tmp <- dat_weekday_mat_down[,-1]
biplot(prcomp(tmp, scale = TRUE), col = c("black", "darkgray"), xlim =
c(-0.5, 0.7), cex = 0.7, main = "Weekday Biplot(down)")

pca_weekend_down <- prcomp(dat_weekend_mat_down[,-1], scale = TRUE)
cumsum(pca_weekend_down$sdev^2)/sum(pca_weekend_down$sdev^2)
### weekday의 경우 PC 2개로 총 변동에 80%를 설명하므로 충분해보임
pca_weekend_down$rotation[,1:2]
### PC1 : 전반적인 하차객수, PC2 : 오전시간 대비 오후시간대의 하차객수(특히 오후 7시 이후 유흥지역이 활발히 운영되는 시간대 높은 값을 가짐)

plot(pca_weekend_down$sdev^2, xlab = "Component number",
     ylab = "Component variance", type = "l", main = "Scree diagram")
tmp2 <- dat_weekend_mat_down[,-1]
biplot(prcomp(tmp2, scale = TRUE), col = c("black", "darkgray"), xlim =
c(-0.5, 0.7), cex = 0.7, main = "Weekend Biplot(down)")
```

### calculate mean from weekend/weeday(up)
```{r}
dat_weekend_mean_up <- dat_weekend_up%>%group_by(Name, Time)%>%summarise(Mean=mean(Count))
dat_weekday_mean_up <- dat_weekday_up%>%group_by(Name, Time)%>%summarise(Mean=mean(Count))

### 평일데이터에 대하여 1달 하차 자료의 시간별 평균 분포 확인
ggplot(data= dat_weekday_mean_up, aes(x=Time, y=Mean, color=Name)) + geom_line(position = 'jitter') +  theme(legend.position="none")

### 주말데이터에 대하여 1달 하차 자료의 시간별 평균 분포 확인
ggplot(data= dat_weekend_mean_up, aes(x=Time, y=Mean, color=Name)) + geom_line(position = 'jitter') +  theme(legend.position="none")
```

### Making Group through MDS technique(up)
```{r, warning=FALSE}
dat_weekend_mat_up <- dat_weekend_mean_up%>%spread(Time, Mean)
dat_weekday_mat_up <- dat_weekday_mean_up%>%spread(Time, Mean)
dim(dat_weekday_mat_up)
# NA 값 => 0으로 처리하였음.
for(i in 1:242){
  dat_weekend_mat_up[i,which(is.na(dat_weekend_mat_up[i,]))] <- 0
  dat_weekday_mat_up[i,which(is.na(dat_weekday_mat_up[i,]))] <- 0
}
colnames(dat_weekend_mat_up) <- c("Name", paste0("time", c(0:2, 4:23)))
colnames(dat_weekday_mat_up) <- c("Name", paste0("time", c(0:2, 4:23)))
dist_weekend_up <- dist(dat_weekend_mat_up[,-1])
dist_weekday_up <- dist(dat_weekday_mat_up[,-1])

#평일 자료에 대한 MDS
mds_weekday_up <- cmdscale(dist_weekday_up, k = 10, eig = TRUE)
mds_weekday_up_eig <- mds_weekday_up$eig
head(cumsum(abs(mds_weekday_up_eig)) / sum(abs(mds_weekday_up_eig)))
head(cumsum((mds_weekday_up_eig)^2) / sum((mds_weekday_up_eig)^2))
#처음 2개의 차원으로 충분 확인 후 1/2차원 표현
plot(mds_weekday_up$points[,1], type = "n", main = "Weekday MDS(up)")
text(mds_weekday_up$points[,1], labels(sort(unique(dat_weekday_up$Name))))

plot(mds_weekday_up$points[,1] * (-1), mds_weekday_up$points[,2] * (-1),
     type = "n", xlab = "Coordinate 1", ylab = "Coordinate 2", main = "Weekday MDS(up)")
text(mds_weekday_up$points[,1] *(-1), mds_weekday_up$points[,2] * (-1), 
     labels(sort(unique(dat_weekday_up$Name))), cex = 0.7)
### 평일의 경우 근무지가 집중된 회사밀집지역에 대하여 데이터가 구분되는 것을 확인.

#주말 자료에 대한 MDS
mds_weekend_up <- cmdscale(dist_weekend_up, k = 10, eig = TRUE)
mds_weekend_up_eig <- mds_weekend_up$eig
head(cumsum(abs(mds_weekend_up_eig)) / sum(abs(mds_weekend_up_eig)))
head(cumsum((mds_weekend_up_eig)^2) / sum((mds_weekend_up_eig)^2))
#처음 1개의 차원으로 충분 확인 후 1/2차원 표현
plot(mds_weekend_up$points[,1], type = "n", main = "Weekend MDS(up)")
text(mds_weekend_up$points[,1], labels(sort(unique(dat_weekday_up$Name))))

plot(mds_weekend_up$points[,1] * (-1), mds_weekend_up$points[,2] * (-1),
     type = "n", xlab = "Coordinate 1", ylab = "Coordinate 2", main = "Weekend MDS(up)")
text(mds_weekend_up$points[,1] *(-1), mds_weekend_up$points[,2] * (-1), 
     labels(sort(unique(dat_weekday_up$Name))), cex = 0.7)
### 주말의 경우 유흥지가 집중된 번화가에 대하여 데이터가 구분되는 것을 확인.
### 또는 잠실(야구경기장), 고속터미널(시외고속버스터미널)에 대한 승차건수가 많음
```

### Making Group through PCA technique(up)
```{r, warning=FALSE}
pca_weekday_up <- prcomp(dat_weekday_mat_up[,-1], scale = TRUE)
plot(pca_weekday_up$sdev^2, xlab = "Component number",
     ylab = "Component variance", type = "l", main = "Scree diagram")
cumsum(pca_weekday_up$sdev^2)/sum(pca_weekday_up$sdev^2)
### weekday의 경우 PC 2개로 총 변동에 82.83%를 설명하므로 충분해보임
pca_weekday_up$rotation[,1:2]
### PC1 : 전반적인 승차객수, PC2 : 오후시간 대비 오전시간대의 승차객수(특히 출근시간대 5,6,7,8,9시에 높은 값을 가짐)
tmp <- dat_weekday_mat_up[,-1]
biplot(prcomp(tmp, scale = TRUE), col = c("black", "darkgray"), xlim =
c(-0.5, 0.7), cex = 0.7, main = "Weekday Biplot(up)")

pca_weekend_up <- prcomp(dat_weekend_mat_up[,-1], scale = TRUE)
cumsum(pca_weekend_up$sdev^2)/sum(pca_weekend_up$sdev^2)
### weekday의 경우 PC 2개로 총 변동에 80%를 설명하므로 충분해보임
pca_weekend_up$rotation[,1:2]
### PC1 : 전반적인 승차객수, PC2 : 오전시간 대비 오후시간대의 승차객수(특히 오후 7시 이후 유흥지역이 활발히 운영되는 시간대 높은 값을 가지며 반대로 5,6,7시 거주지역에서 승차하는 시간대에 낮은 값을 가짐.)

plot(pca_weekend_up$sdev^2, xlab = "Component number",
     ylab = "Component variance", type = "l", main = "Scree diagram")
tmp2 <- dat_weekend_mat_up[,-1]
biplot(prcomp(tmp2, scale = TRUE), col = c("black", "darkgray"), xlim =
c(-0.5, 0.7), cex = 0.7, main = "Weekend Biplot(up)")
```

### Group Selection(PCA, MDS 결과 참고)
* Group 1 : 평일 오전 하차시간대 비슷한 패턴을 가지는 지하철역들(근무지역 예상)
            평일 오후 승차시간대 비슷한 패턴을 가지는 지하철역들
  
* Group 2 : 주말 오후 하차시간대 비슷한 패턴을 가지는 지하철역들(유흥지역 예상)
            주말 늦은 오후 승차시간대 비슷한 패턴을 가지는 지하철역들

* Group 3 : 평일/주말 늦은 하차시간대와 평일/주말 이른 승차시간대 등 비슷한 패턴을 가지는 지하철역들(주거지 예상)

### 0401 subwaydata / handled from Linux
```{r}
load(file = "subway0401.RData")
```

### 예시) 승,하차역이 시청역인 경우
```{r}
sub_cityhall_up <- subway0401[up_Name=="시청",]
sub_cityhall_up <- sub_cityhall_up%>%filter(Time>=15)
sub_cityhall_down <- subway0401[down_Name=="시청",]
sub_cityhall_down <- sub_cityhall_down%>%filter(Time>=4)

sub_cityhall_down <- sub_cityhall_down%>%dplyr::select(ID, up_Name, down_Name, Time)
sub_cityhall_up <- sub_cityhall_up%>%dplyr::select(ID, Time, up_Name, down_Name)%>%rename(Time2=Time,down_Name2=down_Name,up_Name2=up_Name)
sub_cityhall <- left_join(sub_cityhall_down, sub_cityhall_up)
sub_cityhall <- na.omit(sub_cityhall)
sub_cityhall <- sub_cityhall%>%mutate(Timediff = Time2 - Time)
sub_cityhall_diff <- sub_cityhall %>% filter(Timediff>0)
count_cityhall <- sub_cityhall_diff%>%group_by(Timediff)%>%summarise(N=n())
plot(x = count_cityhall$Timediff, y = count_cityhall$N)
```

* 시청의 경우 18.04.01(일)이 주말에도 불구하고 bimodal한 형태를 보이는 것을 확인.

### 예시) 승,하차역이 홍대입구역인 경우
```{r}
sub_hong_up <- subway0401[up_Name=="홍대입구",]
sub_hong_up <- sub_hong_up%>%filter(Time>=15)
sub_hong_down <- subway0401[down_Name=="홍대입구",]
sub_hong_down <- sub_hong_down%>%filter(Time>=4)

sub_hong_down <- sub_hong_down%>%dplyr::select(ID, up_Name, down_Name, Time)
sub_hong_up <- sub_hong_up%>%dplyr::select(ID, Time, up_Name, down_Name)%>%rename(Time2=Time,down_Name2=down_Name,up_Name2=up_Name)
sub_hong <- left_join(sub_hong_down, sub_hong_up)
sub_hong <- na.omit(sub_hong)
sub_hong <- sub_hong%>%mutate(Timediff = Time2 - Time)
sub_hong_diff <- sub_hong %>% filter(Timediff>0)
count_hong <- sub_hong_diff%>%group_by(Timediff)%>%summarise(N=n())
plot(x = count_hong$Timediff, y = count_hong$N)
```

* 그림을 통하여 홍대입구역 정착시간의 분포가 카이제곱분포의 형태를 따르는 것을 확인

### Future Study

1> 잔류시간 관련

* 직장인의 평균 근무시간을 지하철이용객에 한하여 추정

* 유흥밀집지역 이용객들의 평균 잔류시간 추정

* 시각화

2> 출/퇴근시간 관련

* subway_shortestpath를 통한 시간산출 결과를 이용하여 직장인의 평균 통근시간을 지하철이용객에 한하여 추정

* 유흥밀집지역 이용객들의 거주지에서 평균 이동시간

* 주요 밀집지역별 이용객의 거주지 - 밀집지역 거리 확인

* 시각화
