---
title: "Make the key set of the path"
output: html_document
editor_options: 
  chunk_output_type: console
---


## load packages
```{r}
#devtools::install_github("king4k1/seoulsubway")
library(seoulsubway)
library(data.table)
data("subway_data_DT")
```

## get station_name vector for construct matrix
```{r}
transaction_data <- fread(file=file.choose(), encoding = "UTF-8")
# choose transaction data

seoul_route <- transaction_data%>%select(승차역명, 승차호선명)
seoul_route <- unique(seoul_route)
ind1 <- str_locate(seoul_route$승차역명, "[(]")
ind <- ind1[-which(is.na(ind1[,1])),1]
ind2 <- which(is.na(ind1[,1])==TRUE)
seoul_route$승차역명[-ind2] <- str_sub(seoul_route$승차역명[-ind2], 1, ind-1)
seoul_route$승차역명 <- str_replace(seoul_route$승차역명, "서울역", "서울")
seoul_route$승차역명 <- str_replace(seoul_route$승차역명, "이수", "총신대입구")
seoul_route$승차호선명 <- str_sub(seoul_route$승차호선명, 1, 1)
colnames(seoul_route) <- c("Name", "Line")
ind_2_A <- which(seoul_route$Name %in% c("용답","신답","용두","신설동"))
ind_2_B <- which(seoul_route$Name %in% c("도림천","양천구청","신정네거리","까치산"))
ind_5_A <- which(seoul_route$Name %in% c("둔촌동","올림픽공원","방이", "오금","개롱","거여","마천"))
ind_6_A <- which(seoul_route$Name %in% c("역촌","독바위","구산"))
seoul_route[ind_2_A,]$Line <- "2-A"
seoul_route[ind_2_B,]$Line <- "2-B"
seoul_route[ind_5_A,]$Line <- "5-A"
seoul_route[ind_6_A,]$Line <- "6-A"
seoul_route[seoul_route$Name=="신설동"][1]$Line <- "1" # 신설동역 2가지 호선에 대하여 하나는 1호선으로 표기 필요
head(seoul_route)

seoul_station <- subway_data_DT$Name
seoul_station <- sort(unique(seoul_station))
subway_make_list <- data.frame(matrix(0,1,460))
colnames(subway_make_list) <- seoul_station
head(subway_make_list)

```


## function to get route : get_path()

```{r}
depart <- seoul_route[1,]$Name ; depart_line <- seoul_route[1,]$Line
arrival <- seoul_route[2,]$Name ; arrival_line <- seoul_route[2,]$Line

get_path<- function(depart, depart_line, arrival, arrival_line){
result <- shortestpath(depart, depart_line, arrival, arrival_line)

if(result$Time==300){
  Path <- "no result"
  ind <- 0
  result$Info <- data.frame(matrix(0,5,5))
}
if(result$Time!=300 & nrow(result$Info)==1){
  Path <- result$Path
  Path <- Path$Name
  ind <- which(seoul_station%in%Path)
}
if(result$Time!=300 & nrow(result$Info)==2){
  Path <- rbind(result$Path1, result$Path2)
  Path <- Path[-which(duplicated(Path$Name)),]$Name
  ind <- which(seoul_station%in%Path)
}
if(result$Time!=300 & nrow(result$Info)==3){
  Path <- rbind(result$Path1, result$Path2, result$Path3)
  Path <- Path[-which(duplicated(Path$Name)),]$Name
  ind <- which(seoul_station%in%Path)
}
if(result$Time!=300 & nrow(result$Info)==4){
  Path <- rbind(result$Path1, result$Path2, result$Path3, result$Path4)
  Path <- Path[-which(duplicated(Path$Name)),]$Name
  ind <- which(seoul_station%in%Path)
}
return(data.frame(Path, ind))
}

get_path(depart="봉화산", depart_line="6",
                       arrival="강동", arrival_line="5-A")
```


## get list format R data

```{r}
seoul_route <- seoul_route%>%arrange(Name)
subway_route2 <- list()
for(i in 1:276){
  for(j in (i+1):277){
    subway_route2[[paste0(seoul_route[i,]$Name,"(",seoul_route[i,]$Line,")",
                            "-",seoul_route[j,]$Name,"(",seoul_route[j,]$Line,")")]] <- get_path(depart=seoul_route[i,]$Name, depart_line=seoul_route[i,]$Line,
                       arrival=seoul_route[j,]$Name, arrival_line=seoul_route[j,]$Line)
  }
  if(i %in% c(10*(1:25),277)){
    save(file="D:/subway_analysis/data/subway_route2.RData",subway_route2, seoul_route)
  }
}

```


## handling for complete data set

```{r, eval= FALSE}
find_null <- rep(0,37600)
for(i in 1:37600){
  find_null[i] <- nrow(subway_route2[[i]])
}

null_set <- find_null[which(find_null==1)]
null_set_list <- rep(0,33)
for(i in 1:33){
null_set_list[i] <- isTRUE(subway_route2[[which(find_null==1)[i]]][1,1]=="no result")
}
null_index <- which(find_null==1)[null_set_list==1]
null_route_name <-names(subway_route2)[null_index]
null_route <- as.data.frame(null_route_name)

null_route <- separate(null_route, null_route_name, c("depart","depart_line","arrival", "arrival_line"), sep="[(a)]")
null_route$arrival <- str_remove(null_route$arrival, "-")

ind<- which(null_route$arrival%in%c("마곡", "김포공항","송정","방화"))
ind2<- which(null_route$arrival%in%c("도림천","신정네거리","양천구청"))
get_path("구파발","3", "신도림","2")

rbind(get_path("부천시청","7", "영등포구청","5"), get_path("양평", "5","송정","5"))

for(i in 1:20){
subway_route2[[null_route_name[i]]] <- get_path(depart = null_route$depart[i], depart_line = null_route$depart_line[i], arrival=null_route$arrival[i], arrival_line =null_route$arrival_line[i])
}
for(i in ind){
subway_route2[[null_route_name[i]]] <- rbind(get_path(depart = null_route$depart[i], depart_line = null_route$depart_line[i], arrival="영등포구청", arrival_line ="5"), get_path("양평", "5",null_route$arrival[i],"5")) 
}

for(i in ind2){
subway_route2[[null_route_name[i]]] <- rbind(get_path(depart = null_route$depart[i], depart_line = null_route$depart_line[i], arrival="신도림", arrival_line ="2"), get_path("신도림", "2-B",null_route$arrival[i],"2-B")) 
}

subway_route <- subway_route2
#save(file="C:/Users/82104/Desktop/subway_route.RData",subway_route)
#save(file="C:/Users/82104/Desktop/seoul_route.RData", seoul_route)

```


## make function to get total_count from subway path

```{r}

data("subway_sample")
dat <- subway_sample
get_total_count <- function(dat, depart_name, depart_line_name, arrival_name, arrival_line_name){
  data("subway_data_DT")
  seoul_station <- subway_data_DT$Name
  seoul_station <- sort(unique(seoul_station))
  subway_make_list <- data.frame(matrix(0,1,460))
  colnames(subway_make_list) <- seoul_station
  depart <- dat[,depart_name]
  depart_line <- dat[,depart_line_name]
  arrival <- dat[,arrival_name]
  arrival_line <- dat[,arrival_line_name]
  for(i in 1:nrow(dat)){
    get <- paste0(depart[i], "(", depart_line[i], ")", "-", 
                  arrival[i], "(", arrival_line[i], ")")
    get_2 <- paste0(arrival[i], "(", arrival_line[i], ")", "-",
                    depart[i], "(", depart_line[i], ")")
    result <- subway_route[[get]]
    if(is.null(result)){
    result <- subway_route[[get_2]]  
    }
  subway_make_list[result$ind] <- subway_make_list[result$ind] + 1
  }
  return(subway_make_list)
}

get_total_count(dat=dat, depart_name = "up_Name", depart_line_name = "up_Line", arrival_name = "down_Name", arrival_line_name = "down_Line")

```
