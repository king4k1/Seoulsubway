---
title: "Make the key set of the path"
output: html_document
editor_options: 
  chunk_output_type: console
---


## load packages
```{r}
library(seoulsubway)
library(data.table)
library(dplyr)
library(stringr)
data("subway_data_DT")
```

## get station_name vector for construct matrix
```{r}
transaction_data <- fread(file=file.choose(), encoding = "UTF-8")
# choose transaction data

seoul_route <- transaction_data%>%select(승차역명, 승차호선명)
seoul_route <- unique(seoul_route)
ind1 <- str_locate(seoul_route$승차역명, "[(]")
ind <- ind1[-which(is.na(ind1[,1])),1]
ind2 <- which(is.na(ind1[,1])==TRUE)
seoul_route$승차역명[-ind2] <- str_sub(seoul_route$승차역명[-ind2], 1, ind-1)
seoul_route$승차역명 <- str_replace(seoul_route$승차역명, "서울역", "서울")
seoul_route$승차역명 <- str_replace(seoul_route$승차역명, "이수", "총신대입구")
seoul_route$승차호선명 <- str_sub(seoul_route$승차호선명, 1, 1)
colnames(seoul_route) <- c("Name", "Line")
ind_2_A <- which(seoul_route$Name %in% c("용답","신답","용두"))
ind_2_B <- which(seoul_route$Name %in% c("도림천","양천구청","신정네거리"))
ind_5_A <- which(seoul_route$Name %in% c("둔촌동","올림픽공원","방이", "오금","개롱","거여","마천"))
ind_6_A <- which(seoul_route$Name %in% c("역촌","독바위","구산"))
seoul_route[ind_2_A,]$Line <- "2-A"
seoul_route[ind_2_B,]$Line <- "2-B"
seoul_route[ind_5_A,]$Line <- "5-A"
seoul_route[ind_6_A,]$Line <- "6-A"
head(seoul_route)


seoul_station <- subway_data_DT$Name
seoul_station <- sort(unique(seoul_station))
subway_make_list <- data.frame(matrix(0,1,460))
colnames(subway_make_list) <- seoul_station
head(subway_make_list)

```


## function to get route : get_path()

```{r}
depart <- seoul_route[1,]$Name ; depart_line <- seoul_route[1,]$Line
arrival <- seoul_route[2,]$Name ; arrival_line <- seoul_route[2,]$Line

get_path<- function(depart, depart_line, arrival, arrival_line){
result <- shortestpath(depart, depart_line, arrival, arrival_line)

if(result$Time==300){
  Path <- "no result"
  ind <- 0
  result$Info <- data.frame(matrix(0,4,5))
}
if(result$Time!=300 & nrow(result$Info)==1){
  Path <- result$Path
  Path <- Path$Name
  ind <- which(seoul_station%in%Path)
}
if(result$Time!=300 & nrow(result$Info)==2){
  Path <- rbind(result$Path1, result$Path2)
  Path <- Path[-which(duplicated(Path$Name)),]$Name
  ind <- which(seoul_station%in%Path)
}
if(result$Time!=300 & nrow(result$Info)==3){
  Path <- rbind(result$Path1, result$Path2, result$Path3)
  Path <- Path[-which(duplicated(Path$Name)),]$Name
  ind <- which(seoul_station%in%Path)
}
return(data.frame(Path, ind))
}

get_path(depart=seoul_route[1,]$Name, depart_line=seoul_route[1,]$Line,
                       arrival=seoul_route[2,]$Name, arrival_line=seoul_route[2,]$Line)
```


## get list format R data

```{r}
subway_route_set_symmetric <- list()
for(i in 1:276){
  for(j in (i+1):277){
    subway_route_set_symmetric[[paste0(seoul_route[i,]$Name,"(",seoul_route[i,]$Line,")",
                            "-",seoul_route[j,]$Name,"(",seoul_route[j,]$Line,")")]] <- get_path(depart=seoul_route[i,]$Name, depart_line=seoul_route[i,]$Line,
                       arrival=seoul_route[j,]$Name, arrival_line=seoul_route[j,]$Line)
  }
  if(i %in% c(10*(1:27),277)){
    save(file="D:/subway_analysis/data/subway_route_set_symmetric.RData",subway_route_set_symmetric)
  }
}


```


## handling for complete data set

```{r}
load(file = "D:/subway_analysis/data/subway_route_set.RData")

for(i in 273:277){
  for(j in 1:277){
    subway_route_set[[paste0(seoul_route[i,]$Name,"(",seoul_route[i,]$Line,")",
                            "-",seoul_route[j,]$Name,"(",seoul_route[j,]$Line,")")]] <- get_path(depart=seoul_route[i,]$Name, depart_line=seoul_route[i,]$Line,
                       arrival=seoul_route[j,]$Name, arrival_line=seoul_route[j,]$Line)
  }
}

subway_route_set[[76105]]

seoul_route
a <- rep(0,76176)
for(i in 1:76176){
  a[i] <- nrow(subway_route_set[[i]])
}

a[which(a==1)]
k <- rep(0,5473)
for(i in 1:5473){
k[i] <- isTRUE(subway_route_set[[which(a==1)[i]]][1,1]=="no result")
}


sum(k)
i<-1


depart = "종합운동장"
depart_line = "2"
arrival="신도림"
arrival_line <- "2-B"
arrival="성수"
arrival_line <- "2-A"
shortestpath("강동","5","거여","5-A")
get_transferinfo("종합운동장","2","성수","2-A",1)
```